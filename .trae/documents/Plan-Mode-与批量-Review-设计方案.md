# Plan Mode 与批量 Review 设计方案

## 概述

给任务系统添加 Plan Mode 与批量 Review 功能，新任务默认先产出 Plan，Plan 通过后才进入执行队列，支持批量 kick off Plan 并统一 review。

## 核心概念

### Plan Mode

**什么是 Plan Mode？**
- 新任务默认先产出 Plan，而不是直接执行
- Plan 包含：目标、假设、改动点、验收标准、风险
- Plan 通过 review 后，任务才进入执行队列

**为什么需要 Plan Mode？**
- 避免大量无效执行
- 先把需求对齐成本前置
- 提高执行效率

### 批量 Review

**什么是批量 Review？**
- 支持批量 kick off Plan（为多个任务生成 Plan）
- 支持统一 review 多个 Plan
- 提高 review 效率

## Plan 结构

### Plan 模板

```markdown
## Plan：<任务标题>

### 1. 目标
- 明确任务的目标是什么
- 要解决什么问题
- 期望达成什么效果

### 2. 假设
- 任务执行的前提假设
- 哪些条件是已知的
- 哪些条件是需要验证的

### 3. 改动点
- 需要修改哪些文件
- 需要新增哪些文件
- 需要删除哪些文件
- 关键的代码变更点

### 4. 验收标准
- 如何判断任务完成
- 具体的验收条件
- 可量化的指标

### 5. 风险
- 可能遇到的风险
- 风险的应对措施
- 备用方案

### 6. 时间估算
- 预计需要多长时间
- 拆分成哪些阶段
- 每个阶段的时间估算
```

## 工作流程

### Plan Mode 工作流程

```
1. 新任务创建 → 状态：Pending → Planning
2. AI 生成 Plan → 状态：Planning → Plan Review
3. 用户 review Plan → 
   - 批准：状态：Plan Review → In Progress
   - 拒绝：状态：Plan Review → Pending（需要修改 Plan）
4. 执行任务 → 状态：In Progress → Completed
```

### 批量 Review 工作流程

```
1. 选择多个 Pending 任务
2. 批量 kick off Plan（AI 为每个任务生成 Plan）
3. 统一 review 多个 Plan
4. 批量批准/拒绝
5. 批准的任务进入执行队列
```

## 功能设计

### 1. Plan 生成

**功能描述：**
- 为任务自动生成 Plan
- 基于任务标题和描述
- 参考现有 Plan 模板

**实现思路：**
- 使用 LLM 生成 Plan
- 提供 Plan 模板作为提示
- 用户可以编辑生成的 Plan

### 2. Plan Review 界面

**功能描述：**
- 显示 Plan 详情
- 提供批准/拒绝按钮
- 提供修改建议输入框

**界面设计：**
```
┌─────────────────────────────────────────┐
│ Plan：评估 trae-agent 的能力            │
├─────────────────────────────────────────┤
│ 1. 目标                                │
│    ...                                  │
│ 2. 假设                                │
│    ...                                  │
│ 3. 改动点                              │
│    ...                                  │
│ 4. 验收标准                            │
│    ...                                  │
│ 5. 风险                                │
│    ...                                  │
├─────────────────────────────────────────┤
│ [修改 Plan] [批准] [拒绝]              │
│ 拒绝原因：[输入框]                      │
└─────────────────────────────────────────┘
```

### 3. 批量 kick off Plan

**功能描述：**
- 选择多个 Pending 任务
- 批量为这些任务生成 Plan
- 显示生成进度

**实现思路：**
- 任务列表复选框
- 批量选择
- 批量生成 Plan（可以并行或串行）

### 4. 批量 Review 界面

**功能描述：**
- 显示多个 Plan 的摘要
- 支持批量批准
- 支持批量拒绝
- 支持逐个查看详情

**界面设计：**
```
┌─────────────────────────────────────────┐
│ 批量 Review（3 个 Plan）                │
├─────────────────────────────────────────┤
│ ☑ Plan 1：评估 trae-agent 的能力      │
│   摘要：目标是... 改动点包括...        │
│ ☑ Plan 2：...                           │
│ ☑ Plan 3：...                           │
├─────────────────────────────────────────┤
│ [查看详情] [批量批准] [批量拒绝]        │
└─────────────────────────────────────────┘
```

## 任务状态流转

### 状态定义

```
Pending：新创建的任务，等待生成 Plan
Planning：正在生成 Plan
Plan Review：Plan 已生成，等待 review
In Progress：Plan 已批准，正在执行
Completed：任务已完成
Failed：任务执行失败
```

### 状态流转图

```
Pending → Planning → Plan Review → In Progress → Completed
   ↓          ↓          ↓          ↓
         失败      拒绝      失败
            ↓          ↓          ↓
         Pending    Pending     Failed
```

## 推荐方案

**推荐逐步实现：**

### Phase 1：基础 Plan Mode
- Plan 模板
- Plan 生成（手动编写）
- Plan Review 界面
- 状态流转

### Phase 2：AI 自动生成 Plan
- 使用 LLM 自动生成 Plan
- Plan 编辑功能
- Plan 版本历史

### Phase 3：批量 Review
- 批量 kick off Plan
- 批量 Review 界面
- 批量批准/拒绝

## 需要用户决策的问题

1. **Plan Mode 是否默认开启？**
   - 是：所有新任务都先生成 Plan
   - 否：用户可以选择是否使用 Plan Mode
   - 混合：高优先级任务默认开启 Plan Mode

2. **Plan 生成方式？**
   - 方式一：AI 自动生成（快速，但可能不准确）
   - 方式二：用户手动编写（准确，但耗时）
   - 方式三：AI 生成 + 用户编辑（平衡）

3. **Review 流程？**
   - 流程一：必须用户 review 才能执行（安全，但慢）
   - 流程二：AI 生成后自动执行（快速，但风险高）
   - 流程三：低优先级任务自动执行，高优先级需要 review（平衡）

4. **批量 Review 的粒度？**
   - 粒度一：只能批量批准/拒绝（简单）
   - 粒度二：可以逐个查看详情，再批量操作（灵活）

5. **Plan 的存储位置？**
   - 方式一：直接嵌入 todos管理系统.md（简单）
   - 方式二：单独的 Plan 文件（`.trae/plans/` 目录）（清晰）

## 下一步行动

1. 用户确认 Plan Mode 是否默认开启
2. 用户确认 Plan 生成方式
3. 用户确认 Review 流程
4. 实现 Plan 模板
5. 实现 Plan Review 界面
6. 实现状态流转
7. 实现 AI 自动生成 Plan（可选）
8. 实现批量 Review（可选）
