# 任务执行可观测闭环 - 实现方案

## 概述

基于设计方案，开始实现任务执行可观测闭环。

## 我的决策

**存储方案选择**：日志文件 + JSON（简单、快速实现）
**告警阈值**：
- 任务完成率 < 80% → 告警
- 任务失败率 > 20% → 告警
- 平均执行时间 > 30 分钟 → 告警
**重试策略**：最多重试 3 次，间隔分别为立即、5 分钟、15 分钟
**任务产物沉淀**：执行摘要、产物链接、关键 diff、失败复现命令
**指标展示**：先在日志中记录，后续再考虑 Web 界面

---

## 实现

### 1. 任务执行日志系统

创建 `task_executor.py`，实现结构化日志输出。

#### 日志格式

```json
{
  "task_id": "task_20260217_001",
  "timestamp": "2026-02-17T20:00:00Z",
  "level": "INFO",
  "stage": "planning",
  "message": "开始执行任务",
  "details": {
    "task_title": "评估 trae-agent 的能力",
    "assignee": "AI"
  }
}
```

#### 日志级别

- `DEBUG`：详细调试信息
- `INFO`：一般信息
- `WARN`：警告信息
- `ERROR`：错误信息
- `SUCCESS`：成功信息

#### 执行阶段

- `planning`：计划阶段
- `executing`：执行阶段
- `verifying`：验证阶段
- `completed`：完成阶段
- `failed`：失败阶段

---

### 2. 任务状态机

```
Pending → Planning → Executing → Verifying → Completed
   ↓          ↓          ↓          ↓
         Retry Queue  Failed     Failed
```

---

### 3. 重试队列

**重试策略**：
- 立即重试：立即重试 1 次
- 延迟重试：延迟 5 分钟重试 1 次
- 延迟重试：延迟 15 分钟重试 1 次
- 降级：超过 3 次重试，降级为"需要人工补充信息/拆分"

---

### 4. 任务完成率指标

**核心指标**：
- 任务完成率 = 完成任务数 / 总任务数
- 任务失败率 = 失败任务数 / 总任务数
- 平均执行时间 = 总执行时间 / 完成任务数
- 重试率 = 重试任务数 / 总任务数

---

### 5. 任务产物沉淀

**每个任务沉淀以下产物**：

```markdown
### 执行摘要
- 任务目标
- 执行结果
- 关键发现

### 产物链接
- GitHub Commit 链接
- 相关文档链接

### 关键 diff
- 修改的文件列表
- 关键代码变更

### 失败复现命令
- 复现失败的命令
- 复现步骤
```

---

## 下一步

- [ ] 创建 `task_executor.py`
- [ ] 实现结构化日志输出
- [ ] 实现任务状态机
- [ ] 实现重试队列
- [ ] 实现指标收集
- [ ] 实现任务产物沉淀

---

## 决策记录

所有决策已记录，等待用户确认后再继续实现。
