# OpenClaw Session 管理与 Token Usage 优化方案

## 问题分析

### 当前问题
1. **Token 超限错误**：`400 Total tokens of image and text exceed max message tokens`
2. **Token 消耗异常**：今天下午消耗了几千万 token
3. **根本原因**：长期使用一个 session，导致 session history 过长

### 临时解决方案
- 在 TUI 中使用 `/reset` 命令恢复会话

---

## 优化方案设计

### 方案 1: Session 长度监控与自动切换

#### 核心思路
- 监控当前 session 的历史长度
- 当达到阈值时，自动切换到新 session
- 保留关键上下文（如 MEMORY.md、SOUL.md 等）

#### 实现细节
1. **阈值配置**
   - Token 数量阈值：如 80% 的最大限制
   - 消息数量阈值：如 50 条消息
   - 时间阈值：如 24 小时

2. **Session 切换逻辑**
   - 检测到阈值触发时，自动创建新 session
   - 将系统提示词、项目上下文等关键信息迁移到新 session
   - 保留记忆文件（MEMORY.md、daily logs 等）的引用
   - 旧 session 归档，可通过历史记录查看

3. **用户通知**
   - 切换前提示用户
   - 告知切换原因和新 session 的状态

---

### 方案 2: Context 智能压缩与摘要

#### 核心思路
- 不简单丢弃旧消息，而是进行智能压缩
- 对历史对话进行摘要，保留关键信息
- 减少 token 消耗的同时，保持上下文连贯性

#### 实现细节
1. **压缩策略**
   - 对旧消息进行摘要（summarization）
   - 保留工具调用和结果的关键信息
   - 压缩重复或冗余的内容

2. **分级压缩**
   - 最近 N 条消息：完整保留
   - 中间消息：摘要压缩
   - 早期消息：仅保留关键决策和结果

3. **压缩触发**
   - 达到 token 阈值的 60% 时开始压缩
   - 渐进式压缩，避免一次性处理过多

---

### 方案 3: Token 使用监控与优化

#### 核心思路
- 实时监控 token 使用情况
- 识别 token 消耗异常的模式
- 提供优化建议

#### 实现细节
1. **监控指标**
   - 每轮对话的 token 消耗
   - 工具调用的 token 消耗
   - 上下文的 token 占用
   - 每日/每周的 token 使用趋势

2. **异常检测**
   - 突然的 token 消耗激增
   - 重复的工具调用模式
   - 过长的上下文传输

3. **优化建议**
   - 建议切换 session
   - 建议压缩上下文
   - 建议使用更高效的工具调用方式

---

## 综合实施方案

### Phase 1: 基础监控（立即执行）
1. 添加 session 长度和 token 使用的基础监控
2. 在达到阈值时提醒用户
3. 提供手动切换 session 的建议

### Phase 2: 自动切换（短期）
1. 实现自动 session 切换逻辑
2. 配置合理的阈值
3. 测试验证效果

### Phase 3: 智能压缩（中期）
1. 实现 context 摘要压缩
2. 分级压缩策略
3. 平衡 token 效率和上下文连贯性

### Phase 4: 深度优化（长期）
1. 更智能的上下文管理
2. 基于用户行为的个性化优化
3. 持续的 token 使用分析和改进

---

## 下一步行动

1. **先实现 Phase 1**：基础监控和提醒
2. **同时搜索**："Top Lean AI" 榜单的数据源
3. **逐步推进**：按照 Phase 1-4 的顺序实现

---

## 参考资料
- Answer Overflow 讨论：https://www.answeroverflow.com/m/1469215145874948199
- MEMORY.md 中的经验记录
