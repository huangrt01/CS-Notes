# 整体仓库架构设计 - 决策反馈与 Plan 能力融合

## 概述
本文档描述 CS-Notes 项目的整体仓库架构设计，重点考虑决策反馈方式，与 Plan 能力融合。

## 1. 现有架构分析

### 1.1 当前仓库结构
```
CS-Notes/
├── .trae/
│   ├── documents/          # 文档文件夹
│   ├── openclaw-skills/   # OpenClaw 技能
│   ├── rules/             # 规则文件夹
│   ├── skills/            # 通用技能文件夹
│   ├── todos/             # Todo 数据（JSON）
│   ├── logs/              # 日志文件夹
│   └── web-manager/       # Web 管理器
├── Notes/                  # 可复用知识笔记
├── 创作/                 # 面向输出的写作
└── 公司项目/               # 保密项目（永远不git add）
```

### 1.2 当前工作流程
1. **任务输入 → 手机端/Web 端 → INBOX.md / todos.json
2. **任务处理** → Plan Generator → Hybrid Executor
3. **任务执行** → Task Executor → 产物生成
4. **任务反馈** → Git commit & push → 通知用户

## 2. 决策反馈方式设计

### 2.1 决策反馈闭环
```
┌─────────────┐
│  任务输入   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Plan Mode   │ 生成计划
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Plan Review│ 用户确认
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   执行 Plan  │
└──────┬──────┘
       │
       ├── 成功
       │       └── 标记完成 → 沉淀产物
       │
       └── 失败
               └── 分析原因
                       ├── 可重试 → 重试队列
                       └── 不可重试 → 需要人工补充信息/拆分
```

### 2.2 决策点设计
1. **Plan 生成决策
   - 是否需要 Plan？
   - Plan 是否通过？
   - Plan 是否需要调整？

2. **执行决策
   - 使用什么执行方式？（Hybrid Executor）
   - 是否需要中断？
   - 是否需要重试？

3. **反馈决策
   - 任务是否完成？
   - 产物是否符合预期？
   - 是否需要用户确认？

## 3. Plan 能力融合设计

### 3.1 Plan 数据结构
```json
{
  "plan_id": "plan-YYYYMMDD-XXX",
  "task_id": "todo-YYYYMMDD-XXX",
  "title": "Plan 标题",
  "goal": "目标",
  "assumptions": ["假设1", "假设2"],
  "changes": ["改动点1", "改动点2"],
  "acceptance_criteria": ["验收标准1", "验收标准2"],
  "risks": ["风险1", "风险2"],
  "status": "pending|approved|rejected|in-progress|completed",
  "created_at": "ISO-8601",
  "approved_at": "ISO-8601",
  "completed_at": "ISO-8601"
}
```

### 3.2 Plan 与现有系统集成
1. **Plan 存储位置
   - `.trae/plans/plan-YYYYMMDD-XXX.json
   - 与 todos.json 关联

2. **Plan 工作流
   - 新任务 → 自动生成 Plan → Plan Review → 执行 → 完成

3. **Plan 与 Todo 关联
   - Todo 可以有多个 Plan
   - Plan 可以对应多个 Todo

## 4. 整体架构设计

### 4.1 架构图
```
┌─────────────────────────────────────────────────────────┐
│                   用户接口层                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 手机端    │  │ Web 端   │  │ 语音输入  │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
└───────┼─────────────────┼─────────────────┼────────┘
        │                 │                 │
        ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────┐
│                  任务管理层                          │
│  ┌──────────────────────────────────────────┐  │
│  │          Todo Manager                   │  │
│  │  - todos.json (单一数据源)          │  │
│  │  - 任务分类、筛选、排序            │  │
│  └──────────────┬───────────────────────┘  │
│                 │                          │
│  ┌──────────────▼───────────────────────┐  │
│  │          Plan Generator              │  │
│  │  - 自动生成 Plan               │  │
│  │  - Plan Review               │  │
│  └──────────────┬───────────────────────┘  │
│                 │                          │
│  ┌──────────────▼───────────────────────┐  │
│  │      Hybrid Executor           │  │
│  │  - 混合执行方式               │  │
│  │  - 可观测闭环               │  │
│  └──────────────┬───────────────────────┘  │
└─────────────────┼──────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│                  执行层                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ Task     │  │ Git      │  │ 产物     │  │
│  │ Executor│  │ Sync     │  │ Manager  │  │
│  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│                  反馈层                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 通知     │  │ 告警     │  │ 复盘     │  │
│  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 4.2 核心组件
1. **Todo Manager** - 任务管理
2. **Plan Generator** - Plan 生成
3. **Hybrid Executor** - 混合执行
4. **Task Executor** - 任务执行
5. **Git Sync** - Git 同步
6. **Artifact Manager** - 产物管理
7. **Notification** - 通知
8. **Alerting** - 告警
9. **Retrospective** - 复盘

## 5. 数据流向设计

### 5.1 任务输入流程
1. 用户通过手机端/Web 端/语音输入任务
2. Todo Manager 接收任务
3. Plan Generator 生成 Plan
4. Plan Review（用户确认）
5. Hybrid Executor 执行
6. Task Executor 执行具体任务
7. Git Sync 同步代码
8. Artifact Manager 管理产物
9. Notification 通知用户
10. Retrospective 复盘

### 5.2 决策反馈流程
1. 执行过程中产生决策点
2. 根据决策点触发反馈
3. 反馈影响下一步决策
4. 形成闭环

## 6. 实施路线图

### Phase 1: 基础架构搭建
- [ ] 创建 Plan 数据结构
- [ ] 创建 Plan Generator
- [ ] 集成 Plan 与 Todo Manager
- [ ] 创建决策反馈机制

### Phase 2: 执行层增强
- [ ] 增强 Hybrid Executor
- [ ] 增强 Task Executor
- [ ] 增强 Artifact Manager
- [ ] 增强 Git Sync

### Phase 3: 反馈层完善
- [ ] 完善 Notification
- [ ] 完善 Alerting
- [ ] 完善 Retrospective
- [ ] 完善可观测闭环

### Phase 4: 整体优化
- [ ] 整体集成测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 总结

本文档设计了 CS-Notes 项目的整体仓库架构，重点考虑了决策反馈方式，与 Plan 能力融合。通过这个架构，可以实现：

1. **完整的任务管理** - 从输入到输出的完整流程
2. **决策反馈闭环** - 每个决策点都有反馈
3. **Plan 能力融合** - Plan 与现有系统无缝集成
4. **可观测性** - 整个流程可观测、可追溯
5. **可扩展性** - 架构易于扩展和维护
