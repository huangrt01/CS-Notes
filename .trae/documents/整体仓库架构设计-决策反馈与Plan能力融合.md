# 整体仓库架构设计 - 决策反馈方式与 Plan 能力融合

## 📋 概述

本文档分析 CS-Notes 项目的现有整体仓库架构，设计决策反馈方式，将决策反馈方式与 Plan 能力融合起来，形成完整的架构设计文档。

---

## 🏗️ 现有整体仓库架构分析

### 仓库结构

```
CS-Notes/
├── .trae/
│   ├── documents/           # 文档文件夹
│   │   ├── INBOX.md         # 任务收件箱
│   │   ├── TODO_ARCHIVE.md  # 已完成任务归档
│   │   ├── TEMPLATES.md    # 任务模板
│   │   ├── PROGRESS.md     # 执行进度记录
│   │   ├── todos管理系统.md # 任务管理系统
│   │   └── ...             # 其他文档
│   ├── openclaw-skills/    # OpenClaw 技能
│   │   ├── trae-agent/     # Trae Agent 技能
│   │   ├── session-optimizer/ # Session 优化器技能
│   │   └── ...             # 其他技能
│   ├── rules/              # 规则文件夹
│   │   └── project_rules.md # 项目规则
│   ├── skills/             # 通用技能文件夹
│   │   ├── code-reviewer/   # 代码审查技能
│   │   ├── find-skills/     # 发现技能
│   │   ├── fix/             # 修复技能
│   │   └── pr-creator/      # PR 创建技能
│   └── web-manager/        # Todos Web Manager
│       └── index.html      # Web Manager MVP
├── Notes/                  # 可复用知识笔记
│   ├── AI-Agent-Product&PE.md # AI Agent 产品与 PE
│   ├── 深度学习推荐系统.md   # 深度学习推荐系统
│   ├── snippets/           # 脚本和小工具
│   │   ├── todo-sync.sh    # Todo 同步脚本
│   │   ├── todo-push.sh    # Todo Push 脚本
│   │   ├── todo-pull.sh    # Todo Pull 脚本
│   │   ├── voice_task_parser.py # 语音任务解析器
│   │   ├── speech_to_text.py # 语音转写工具
│   │   └── ...             # 其他脚本
│   └── ...                 # 其他笔记
├── 创作/                   # 面向输出的写作
├── 公司项目/                # 保密项目（永远不 git add）
├── trae-agent/             # Trae Agent 目录
└── ...                     # 其他文件
```

### 现有架构特点

1. **任务管理系统**：
   - 使用 Markdown 格式管理任务
   - 分为 Pending、In Progress、Completed 三个阶段
   - 支持任务字段扩展（Priority、Assignee、Feedback Required、Links、Definition of Done、Progress、Deliverables 等）

2. **Git 版本控制**：
   - 使用 Git 同步任务
   - todo-push.sh 和 todo-pull.sh 作为标准 git 操作流程
   - 白名单机制：仅允许 `Notes/`、`.trae/`、`创作/` 三个文件夹
   - 黑名单机制：绝对禁止 `公司项目/` 文件夹

3. **技能系统**：
   - OpenClaw Skills：`.trae/openclaw-skills/`
   - 通用技能：`.trae/skills/`
   - 本地脚本：`Notes/snippets/`

4. **Web Manager**：
   - MVP 已实现：`.trae/web-manager/index.html`
   - 包含任务列表、添加任务、标记完成、按状态筛选、优先级设置、响应式设计

---

## 🎯 决策反馈方式设计

### 决策反馈方式

#### 方式一：文档决策区域（当前方式）

**特点：**
- 在每个设计方案文档中，明确列出"需要用户决策的问题"
- 用户通过在文档中标记选择项（如 "———— 用户选择"）来表达决策
- AI 读取文档，识别用户决策，然后更新 todo 管理系统

**优点：**
- 简单，不需要额外的工具
- 决策历史记录完整，便于追溯
- 适合异步决策

**缺点：**
- 需要用户手动编辑文档
- 决策不够直观
- 难以批量决策

#### 方式二：Todos Web Manager 决策界面（推荐）

**特点：**
- 在 Todos Web Manager 中，为每个需要决策的任务提供决策界面
- 用户可以直接在 Web Manager 中选择决策选项
- 决策自动保存到 Markdown 文档中

**优点：**
- 直观，易于使用
- 支持批量决策
- 决策历史记录完整

**缺点：**
- 需要实现 Web Manager 的决策界面
- 需要后端支持

#### 方式三：自然语言对话决策（补充）

**特点：**
- 用户通过自然语言对话表达决策
- AI 理解用户意图，自动更新 todo 管理系统
- 适合快速、简单的决策

**优点：**
- 最自然，最易用
- 不需要额外的工具

**缺点：**
- 决策历史记录不够完整
- 难以处理复杂的决策
- 不适合批量决策

---

## 🔗 Plan 能力融合

### Plan 能力概述

Plan Mode 是任务系统的核心能力：
- 新任务默认先产出 Plan（目标、假设、改动点、验收标准、风险）
- Plan 通过后才进入执行队列
- 支持批量 kick off Plan 并统一 review
- Plan 与执行拆分成两类条目：Plan 条目更强调意图与验收；执行条目更强调产物与可追溯性
- 支持混合执行方式：当遇到复杂任务时，先生成 Plan，然后先自动执行，再用 AI 自动生成的方式

### Plan 能力与决策反馈方式的融合

#### 融合方式一：Plan 文档 + 决策反馈

**架构：**
```
用户需求 → Plan Generator → Plan 文档 → 用户决策 → 执行
```

**流程：**
1. 用户提出需求
2. Plan Generator 生成 Plan 文档（`.trae/plans/` 目录）
3. 用户通过文档决策区域或 Web Manager 决策界面表达决策
4. 决策通过后，进入执行队列

**优点：**
- Plan 文档独立存储，便于管理和追溯
- 决策反馈方式灵活，支持多种方式
- 适合复杂任务

#### 融合方式二：Plan 嵌入 todo 管理系统 + 决策反馈

**架构：**
```
用户需求 → Plan Generator → Plan 嵌入 todo 管理系统 → 用户决策 → 执行
```

**流程：**
1. 用户提出需求
2. Plan Generator 生成 Plan，直接嵌入 todos管理系统.md
3. 用户通过文档决策区域或 Web Manager 决策界面表达决策
4. 决策通过后，进入执行队列

**优点：**
- Plan 与任务在一起，便于查看和管理
- 不需要额外的 Plan 目录
- 适合简单任务

---

## 🏛️ 完整架构设计

### 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户界面层                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  自然语言对话   │  │  Todos Web    │  │  文档决策区域  │ │
│  │  (Lark/飞书)    │  │  Manager       │  │                 │ │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘ │
└───────────┼───────────────────────┼───────────────────────┼───────┘
            │                       │                       │
            ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                         决策反馈层                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              决策解析与更新模块                          │   │
│  │  - 解析自然语言决策                                      │   │
│  │  - 解析 Web Manager 决策                                 │   │
│  │  - 解析文档决策区域                                      │   │
│  │  - 更新 todo 管理系统                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Plan 层                                  │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  Plan Generator │  │  Plan Executor  │  │  Plan Reviewer  │ │
│  │                 │  │                 │  │                 │ │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘ │
└───────────┼───────────────────────┼───────────────────────┼───────┘
            │                       │                       │
            ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                         任务管理层                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              todo 管理系统 (todos管理系统.md)             │   │
│  │  - Pending: 待处理任务                                    │   │
│  │  - In Progress: 进行中任务                                │   │
│  │  - Completed: 已完成任务                                  │   │
│  │  - AI 需要做的任务：优先执行                              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                         执行层                                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  OpenClaw       │  │  Trae Agent     │  │  方舟模型        │ │
│  │  (简单任务)      │  │  (复杂任务)      │  │  (代码任务)      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 核心组件

#### 1. 用户界面层
- **自然语言对话 (Lark/飞书)**：用户通过自然语言对话表达需求和决策
- **Todos Web Manager**：用户通过 Web 界面管理任务和决策
- **文档决策区域**：用户通过编辑 Markdown 文档表达决策

#### 2. 决策反馈层
- **决策解析与更新模块**：解析各种决策方式，更新 todo 管理系统

#### 3. Plan 层
- **Plan Generator**：自动生成 Plan
- **Plan Executor**：执行 Plan
- **Plan Reviewer**：批量 review Plan

#### 4. 任务管理层
- **todo 管理系统 (todos管理系统.md)**：管理任务的整个生命周期

#### 5. 执行层
- **OpenClaw**：执行简单任务
- **Trae Agent**：执行复杂任务
- **方舟模型**：执行代码任务

---

## 📝 下一步行动

1. **实现 Plan 存储方案**：
   - 创建 `.trae/plans/` 目录（已完成）
   - 实现 Plan 文件命名规则和格式

2. **实现 Plan Generator**：
   - 创建 Plan Generator Skill（`.trae/openclaw-skills/plan-generator/`）
   - 自动生成 Plan 并写入 `.trae/plans/`

3. **实现 Plan Executor**：
   - 创建 Plan Executor Skill（`.trae/openclaw-skills/plan-executor/`）
   - 读取 Plan 并执行

4. **实现 Hybrid Executor**：
   - 创建 Hybrid Executor Skill（`.trae/openclaw-skills/hybrid-executor/`）
   - 调度混合执行流程

5. **实现决策反馈方式**：
   - 在 Todos Web Manager 中添加决策界面
   - 实现决策解析与更新模块

6. **整体架构整合**：
   - 将所有组件整合起来
   - 测试完整流程

---

## 🎯 总结

本文档分析了 CS-Notes 项目的现有整体仓库架构，设计了决策反馈方式，将决策反馈方式与 Plan 能力融合起来，形成了完整的架构设计文档。

**核心要点：**
1. 三种决策反馈方式：文档决策区域（当前方式）、Todos Web Manager 决策界面（推荐）、自然语言对话决策（补充）
2. 两种 Plan 能力融合方式：Plan 文档 + 决策反馈（适合复杂任务）、Plan 嵌入 todo 管理系统 + 决策反馈（适合简单任务）
3. 完整架构设计：用户界面层 → 决策反馈层 → Plan 层 → 任务管理层 → 执行层

**下一步：**
1. 实现 Plan 存储方案
2. 实现 Plan Generator、Plan Executor、Hybrid Executor
3. 实现决策反馈方式
4. 整体架构整合

