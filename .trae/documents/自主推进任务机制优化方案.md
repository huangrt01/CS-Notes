
# 自主推进任务机制优化方案

## 问题背景
- 当前主要依赖 heartbeat 来触发自主推进任务
- heartbeat 间隔较长（默认 30 分钟），可能会错过需要及时推进的任务
- 希望在用户两次交互之间主动推进任务，不等待 heartbeat
- 希望闭环自我迭代：执行 → 发现新任务 → 添加新任务 → 继续执行

## 优化目标
- 在用户两次交互之间主动推进任务，不等待 heartbeat
- 支持闭环自我迭代
- 在两次用户干预之间最多执行 MAX_TASKS_BETWEEN_INTERVENTIONS（8）个任务
- 最多并发 MAX_CONCURRENT_SUBAGENTS（5）个子 agent
- 优先执行 Assignee: AI 的任务
- 优先执行 Priority: high 的任务
- 跳过 Feedback Required: 是的任务
- 只有需要用户做选择题的时候才找用户确认
- 否则尽量自主推进一切事项

## 优化方案

### 方案一：用户交互触发重置 + 主动推进
**核心思路**：
1. 每次用户交互（发送消息）时，重置"两次干预之间已执行的任务数量"
2. 在每次工具调用后，检查"两次干预之间已执行的任务数量"
3. 如果已执行数量 < MAX_TASKS_BETWEEN_INTERVENTIONS，则继续推进任务
4. 如果已执行数量 >= MAX_TASKS_BETWEEN_INTERVENTIONS，则等待下次用户干预

**实现细节**：
- 在 `.trae/todos/` 下创建 `execution_state.json` 文件，记录：
  - `last_user_interaction_at`: 上次用户交互时间
  - `tasks_executed_since_last_interaction`: 两次干预之间已执行的任务数量
- 每次用户发送消息时，更新 `last_user_interaction_at` 并重置 `tasks_executed_since_last_interaction` 为 0
- 每次完成一个任务后，递增 `tasks_executed_since_last_interaction`
- 每次完成任务后，检查 `tasks_executed_since_last_interaction` 是否 < MAX_TASKS_BETWEEN_INTERVENTIONS，如果是，则继续推进下一个任务

---

## 实施阶段

### Phase 1: 实现基础框架
- 创建 `execution_state.json` 文件
- 实现用户交互重置机制
- 实现任务执行计数机制

### Phase 2: 实现主动推进逻辑
- 在每次任务完成后，检查是否可以继续推进下一个任务
- 实现任务选择逻辑（优先 Assignee: AI、Priority: high、跳过 Feedback Required: 是的任务）

### Phase 3: 实现闭环自我迭代
- 在执行任务过程中，自动发现对齐最终目标的新 todos
- 自动添加新 todos 到 todo manager
- 继续执行新添加的 todos

### Phase 4: 测试验证
- 测试整个流程
- 调整 MAX_TASKS_BETWEEN_INTERVENTIONS 和 MAX_CONCURRENT_SUBAGENTS 参数

---

## 参数配置
```python
# 在两次用户干预期间最多执行的任务数量（可配置，未来可以调高）
MAX_TASKS_BETWEEN_INTERVENTIONS = 8

# 最多并发的子 agent 数量
MAX_CONCURRENT_SUBAGENTS = 5
```

---

## 与现有架构的融合
- 与 existing todo manager 融合
- 与 existing heartbeat 机制融合（heartbeat 作为后备方案）
- 与 existing Todos Web Manager 融合

