# 任务执行可观测闭环 - 重新设计与落地方案

## 🎯 核心目标

**不再是玩具代码，而是成为 OpenClaw 的默认能力！**

---

## 📋 当前问题诊断

1. ❌ `task_execution_logger.py` - 只是个独立脚本，没有和 OpenClaw 集成
2. ❌ `example_task_with_logger.py` - 只是示例，没有实际用起来
3. ❌ 设计文档太多，没有落地
4. ❌ 没有结合 Git 同步架构
5. ❌ 没有和 todos.json 集成

---

## 🏗️ 重新设计：三步走方案

### Phase 1: 最小可用版本（MVP）- 本周落地

**目标：让能力真正产生价值，而不是停留在文档**

#### 1.1 修改 todos.json 数据结构

在现有任务字段基础上，增加：

```json
{
  "id": "todo-20260221-001",
  "title": "xxx",
  "status": "in-progress",
  
  // 新增：执行日志
  "execution_log": [
    {
      "timestamp": "2026-02-21T10:00:00Z",
      "stage": "planning|executing|verifying|completed|failed",
      "message": "开始执行任务",
      "details": {}
    }
  ],
  
  // 新增：执行指标
  "execution_metrics": {
    "started_at": "2026-02-21T10:00:00Z",
    "completed_at": null,
    "execution_time_seconds": 0,
    "retry_count": 0
  },
  
  // 新增：沉淀产物（直接放在任务里，不用额外文件）
  "artifacts": {
    "execution_summary": "",
    "product_links": [],
    "key_diffs": [],
    "reproduction_commands": []
  }
}
```

**理由**：
- 直接集成在 todos.json 里，Git 同步就能带走
- 不需要额外的日志文件
- Web Manager 直接就能展示

#### 1.2 创建 OpenClaw Skill: `task-executor`

**位置**：`.trae/openclaw-skills/task-executor/`

**功能**：
- 包装任务执行，自动记录日志到 todos.json
- 失败时自动重试
- 完成时自动沉淀产物
- 可以被 OpenClaw 云端和本地 Trae 同时使用

**使用方式**：
```python
# 在 OpenClaw Skill 中
from task_executor import execute_task

async def my_skill_handler(task):
    result = await execute_task(
        task_id=task.id,
        executor=my_actual_task_function,
        retry_count=3
    )
    return result
```

#### 1.3 在 Web Manager 中增加执行历史面板

在现有 Web Manager 基础上，增加：
- 每个任务卡片下方显示执行历史
- 顶部显示整体执行指标（完成率、失败率、平均执行时间）
- 失败任务高亮显示

---

### Phase 2: 增强版 - 2周内落地

**目标：让能力更强大、更易用**

1. **智能重试策略**：
   - 根据失败原因选择重试间隔
   - 超过阈值自动降级为"需要人工补充信息"

2. **告警机制**：
   - 任务完成率 < 80% 时，在 Web Manager 显示告警
   - 失败率 > 20% 时，显示告警

3. **产物可视化**：
   - 在 Web Manager 中直接展示执行摘要、产物链接、关键 diff

---

### Phase 3: 深度集成 - 1个月内落地

**目标：成为 OpenClaw 的默认能力**

1. **OpenClaw 原生集成**：
   - 修改 OpenClaw 的任务执行流程，默认使用这个能力
   - 不需要手动包装，开箱即用

2. **多端同步**：
   - 云端 OpenClaw 执行的任务，本地 Trae 能看到执行日志
   - 本地 Trae 执行的任务，云端 OpenClaw 也能看到

---

## 🚀 立即开始：Phase 1 MVP 实现

### 第一步：修改 todos.json 数据结构

先修改几个现有任务，增加执行日志字段，验证可行性。

### 第二步：创建简化版 task-executor Skill

不要过度设计，先做最小可用版本。

### 第三步：在 Web Manager 中展示执行历史

修改 `index-enhanced.html`，在任务卡片下方显示 execution_log。

---

## 📊 价值衡量标准

**不再看写了多少代码，而是看：**

1. ✅ OpenClaw 执行任务时，是否自动记录了日志？
2. ✅ 任务失败时，是否自动重试了？
3. ✅ Web Manager 中是否能看到执行历史？
4. ✅ 这个能力是否被实际用起来了（而不是放在角落）？

---

*最后更新：2026-02-21*
