# 任务执行可观测闭环设计方案

## 概述

为任务执行引入可观测性，让调度器能识别执行阶段、失败原因、重试点与最终产物。

## 核心概念

### 可观测性三支柱

1. **日志（Logging）**：记录任务执行的详细日志
2. **指标（Metrics）**：任务完成率、执行时间、失败率等
3. **追踪（Tracing）**：任务执行的完整链路追踪

## 设计方案

### 1. 结构化日志输出

**日志格式：JSON Stream**

```json
{
  "task_id": "task_20260217_001",
  "timestamp": "2026-02-17T20:00:00Z",
  "level": "INFO",
  "stage": "planning",
  "message": "开始执行任务",
  "details": {
    "task_title": "评估 trae-agent 的能力",
    "assignee": "AI"
  }
}
```

**日志级别：**
- `DEBUG`：详细调试信息
- `INFO`：一般信息
- `WARN`：警告信息
- `ERROR`：错误信息
- `SUCCESS`：成功信息

**执行阶段：**
- `planning`：计划阶段
- `executing`：执行阶段
- `verifying`：验证阶段
- `completed`：完成阶段
- `failed`：失败阶段

### 2. 任务状态机

```
Pending → Planning → Executing → Verifying → Completed
   ↓          ↓          ↓          ↓
         Retry Queue  Failed     Failed
```

### 3. 重试队列

**重试策略：**
- 立即重试：立即重试 1 次
- 延迟重试：延迟 5 分钟重试 1 次
- 延迟重试：延迟 15 分钟重试 1 次
- 降级：超过 3 次重试，降级为"需要人工补充信息/拆分"

### 4. 任务完成率指标

**核心指标：**
- 任务完成率 = 完成任务数 / 总任务数
- 任务失败率 = 失败任务数 / 总任务数
- 平均执行时间 = 总执行时间 / 完成任务数
- 重试率 = 重试任务数 / 总任务数

**阈值设置：**
- 任务完成率 < 80% → 告警
- 任务失败率 > 20% → 告警
- 平均执行时间 > 30 分钟 → 告警

### 5. 任务产物沉淀

**每个任务沉淀以下产物：

```markdown
### 执行摘要
- 任务目标
- 执行结果
- 关键发现

### 产物链接
- GitHub Commit 链接
- 相关文档链接

### 关键 diff
- 修改的文件列表
- 关键代码变更

### 失败复现命令
- 复现失败的命令
- 复现步骤
```

## 技术实现方案

### 方案一：基于日志文件 + JSON 格式

**优点：**
- 实现简单
- 无需额外依赖
- 易于调试

**缺点：**
- 查询效率较低
- 不支持实时查询

**实现：**
- 日志文件：`.trae/logs/task_execution_20260217.jsonl`
- 每行一个 JSON 对象
- 按日期分割文件

### 方案二：SQLite 数据库

**优点：**
- 查询效率高
- 支持复杂查询
- 支持索引

**缺点：**
- 需要数据库依赖
- 需要维护数据库 schema

**实现：**
- 数据库文件：`.trae/logs/task_execution.db`
- 表结构：tasks、logs、metrics

### 方案三：基于现有 Git 历史

**优点：**
- 无需额外存储
- 利用 Git 历史
- 天然版本控制

**缺点：**
- 查询复杂
- 需要解析 Git 历史

## 实现：**
- 从 Git commit 历史提取信息
- 从 commit message 提取任务信息

## 推荐方案

**推荐方案一（日志文件 + JSON 格式），原因：
1. 实现简单
2. 易于调试
3. 后续可以升级到方案二

## 需要用户决策的问题

1. **可观测性数据存储方案选择：**
   - 方案一：日志文件 + JSON 格式（简单）———— 用户选择
   - 方案二：SQLite 数据库（强大）
   - 方案三：基于现有 Git 历史（无额外存储）

2. **告警阈值设置**：
   - 任务完成率低于多少需要告警？（默认 80%）
   - 任务失败率高于多少需要告警？（默认 20%）
   - 平均执行时间超过多少需要告警？（默认 30 分钟）

3. **重试策略**：
   - 最多重试几次？（默认 3 次）
   - 重试间隔如何设置？（立即）

4. **任务产物沉淀**：
   - 每个任务需要沉淀哪些产物？—————— 你自由发挥
   - 产物格式如何？—————— 你自由发挥

5. **指标展示**：
   - 是否需要一个 Web 界面展示指标？—————— 融入 Web Manager 展示
   - 还是仅在日志中记录即可？—————— 日志 + Web Manager

## 下一步行动

1. 用户确认存储方案
2. 用户确认告警阈值
3. 用户确认重试策略
4. 实现结构化日志输出
5. 实现任务状态机
6. 实现重试队列
7. 实现指标收集
8. 实现任务产物沉淀
