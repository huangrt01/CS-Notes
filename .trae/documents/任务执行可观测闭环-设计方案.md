# 任务执行可观测闭环 - 设计方案

## 简介

为任务执行引入可观测闭环，让调度器能识别执行阶段、失败原因、重试点与最终产物。

## 设计目标

1. **结构化日志输出**：任务执行采用结构化日志输出（如 stream-json）
2. **核心系统指标**：任务完成率作为核心系统指标
3. **失败任务处理**：失败任务进入重试队列，超过阈值自动降级为"需要人工补充信息/拆分"的任务
4. **任务沉淀产物**：每个任务沉淀产物：执行摘要、产物链接、关键 diff、失败复现命令，回写到任务条目下，便于长期复盘

## 结构化日志输出

### 日志格式

采用 JSON 格式的结构化日志：

```json
{
  "version": "1.0.0",
  "timestamp": "2026-02-19T10:00:00+08:00",
  "task_id": "todo-20260219-001",
  "task_title": "实现 todo 同步脚本",
  "phase": "init|executing|completed|failed",
  "status": "success|failure",
  "execution_summary": "简要描述执行内容",
  "product_links": ["https://github.com/...", "..."],
  "key_diff": "git diff 内容",
  "retry_command": "复现命令",
  "failure_reason": "失败原因",
  "failure_stage": "失败阶段",
  "retry_point": "重试点",
  "metadata": {
    "started_at": "2026-02-19T10:00:00+08:00",
    "completed_at": "2026-02-19T10:05:00+08:00",
    "duration_ms": 300000,
    "assignee": "AI"
  }
}
```

### 日志输出位置

- **实时日志**：输出到 stdout/stderr
- **持久化日志**：保存到 `.trae/logs/tasks/YYYY-MM-DD.jsonl`
- **任务回写**：回写到 `.trae/documents/todos管理系统.md` 中对应的 todo 条目下

## 核心系统指标

### 任务完成率

**计算方式**：
```
任务完成率 = 已完成任务数 / 总任务数
```

**监控阈值**：
- 正常：≥ 90%
- 警告：70% - 90%
- 异常：< 70%

**告警机制**：
- 当任务完成率 < 70% 时，自动向用户发送告警
- 告警内容：任务完成率、失败任务列表、建议措施

## 失败任务处理

### 重试队列

**失败任务进入重试队列**：
- 第一次失败：自动重试 1 次
- 第二次失败：自动重试 2 次
- 第三次失败：自动降级为"需要人工补充信息/拆分"的任务

### 自动降级

**自动降级为"需要人工补充信息/拆分"的任务**：
- 在 todo 条目标记为"Feedback Required: 是"
- 在 todo 条目标记为"Priority: high"
- 在 todo 条目标记为"需要人工补充信息/拆分"
- 在 todo 条目标记失败原因和失败阶段

## 任务沉淀产物

### 回写格式

在 todo 条目中添加"沉淀产物" section：

```markdown
* [x] 实现 todo 同步脚本
  - Priority：high
  - Assignee：AI
  - Feedback Required：否
  - Definition of Done：
    * ...
  - Progress：
    * ✅ 已完成
  - 沉淀产物：
    * 执行摘要：[简要描述执行内容]
    * 产物链接：https://github.com/...
    * 关键 diff：[git diff 内容]
    * 失败复现命令：[复现命令]
```

### 产物内容

**执行摘要**：简要描述执行内容
**产物链接**：相关链接（GitHub Commit、文档链接等）
**关键 diff**：git diff 内容（可选）
**失败复现命令**：复现命令（如果失败）

---

## 实施计划

### Phase 1：基础日志
1. 设计结构化日志格式
2. 实现基础日志输出
3. 保存日志到 `.trae/logs/tasks/YYYY-MM-DD.jsonl`

### Phase 2：指标监控
1. 实现任务完成率计算
2. 实现监控阈值
3. 实现告警机制

### Phase 3：失败处理
1. 实现重试队列
2. 实现自动重试逻辑
3. 实现自动降级逻辑

### Phase 4：产物沉淀
1. 实现任务回写逻辑
2. 实现沉淀产物格式
3. 测试完整流程

---

*最后更新：2026-02-19*
